<section class="services">
  <header class="toolbar">
    <h2>Agendamentos</h2>
    <div class="tools">
      <label class="search">
        <input
          type="search"
          placeholder="Buscar por paciente, profissional ou tipo..."
          [formControl]="searchControl" />
      </label>

      <label class="filter">
        <select [formControl]="statusControl" class="select sm">
          <option value="">Todos</option>
          <option value="Agendado">Agendado</option>
          <option value="Concluído">Concluído</option>
          <option value="Cancelado">Cancelado</option>
        </select>
      </label>

      <button class="btn btn-primary" type="button" (click)="startCreate()">Novo agendamento</button>
    </div>
  </header>

  <section class="panel">
    <div class="panel__head">
      <h3>Lista</h3>
      <div class="panel__actions">
        <button class="btn btn-outline" type="button" (click)="load(page)" [disabled]="loading" [attr.aria-busy]="loading ? 'true' : null">
          {{ loading ? 'Atualizando...' : 'Atualizar' }}
        </button>
      </div>
    </div>

    <ng-container *ngIf="!loading && filtered?.length; else loadingOrEmpty">
      <div class="table-responsive">
        <table class="table">
          <thead>
          <tr>
            <th>Data</th>
            <th>Paciente</th>
            <th>Profissional</th>
            <th>Tipo</th>
            <th>Status</th>
            <th class="th-actions"></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let s of filtered; trackBy: trackById">
            <td [attr.data-label]="'Data'">{{ s.scheduled_date | date:'short' }}</td>
            <td [attr.data-label]="'Paciente'">{{ s.patient?.name || '—' }}</td>
            <td [attr.data-label]="'Profissional'">
              {{ s.professional?.name || '—' }}
              <ng-container *ngIf="s.professional?.specialty"> ({{ s.professional?.specialty }})</ng-container>
            </td>
            <td [attr.data-label]="'Tipo'">{{ s.service_type || '—' }}</td>
            <td [attr.data-label]="'Status'">
              <span class="badge"
                [ngClass]="{
                  'scheduled': s.status==='Agendado',
                  'done': s.status==='Concluído',
                  'cancelled': s.status==='Cancelado'
                }">{{ s.status }}</span>
            </td>
            <td class="actions" [attr.data-label]="'Ações'">
              <button class="btn btn-outline" type="button" (click)="startEdit(s)">Editar</button>
              <button class="btn btn-danger"  type="button" (click)="remove(s)">Remover</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="pager">
        <button class="btn btn-outline" [disabled]="page<=1" (click)="load(page-1)">Anterior</button>
        <div class="pageinfo">Página {{ page }} de {{ lastPage }}</div>
        <button class="btn btn-outline" [disabled]="page>=lastPage" (click)="load(page+1)">Próxima</button>
      </div>
    </ng-container>

    <ng-template #loadingOrEmpty>
      <div *ngIf="loading" class="skeleton">
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]">
          <span class="sk sk-sm"></span><span class="sk"></span><span class="sk"></span><span class="sk"></span><span class="sk sk-badge"></span><span class="sk sk-btn"></span>
        </div>
      </div>
      <div *ngIf="!loading && (!filtered || !filtered.length)" class="empty">
        <p>Nenhum agendamento encontrado.</p>
        <button class="btn btn-primary" (click)="startCreate()">Criar agendamento</button>
      </div>
    </ng-template>
  </section>

  <div class="overlay" *ngIf="drawerOpen" (click)="closeForm()" aria-hidden="true"></div>

  <aside class="drawer" [class.open]="drawerOpen" role="dialog" aria-modal="true" aria-label="Formulário de agendamento">
    <header class="drawer__head">
      <h3 class="title">
        {{ editing ? 'Editar agendamento' : 'Novo agendamento' }}
        <small class="subtitle" *ngIf="!editing">Preencha os dados abaixo</small>
        <small class="subtitle" *ngIf="editing">Atualize o necessário</small>
      </h3>
      <button class="icon close" type="button" (click)="closeForm()" aria-label="Fechar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </header>

    <form [formGroup]="form" (ngSubmit)="save()" class="drawer__form">
      <div class="drawer__content">
        <div class="inset">
          <div class="form-grid form-compact">
            <label class="field col-12">
              <span>Paciente</span>
              <select class="select" formControlName="patient_id">
                <option [ngValue]="null">Selecione...</option>
                <option *ngFor="let p of patients" [ngValue]="p.id">{{ p.name }}</option>
              </select>
            </label>

            <label class="field col-12">
              <span>Profissional</span>
              <select class="select" formControlName="professional_id">
                <option [ngValue]="null">Selecione...</option>
                <option *ngFor="let pr of professionals" [ngValue]="pr.id">
                  {{ pr.name }} <ng-container *ngIf="pr.specialty">({{ pr.specialty }})</ng-container>
                </option>
              </select>
            </label>

            <label class="field col-12">
              <span>Tipo de serviço</span>
              <input class="input" formControlName="service_type" placeholder="Curativo, Fisioterapia..." />
            </label>

            <label class="field col-7">
              <span>Data/Hora</span>
              <input type="datetime-local" class="input" formControlName="scheduled_date" />
            </label>

            <label class="field col-5">
              <span>Status</span>
              <select class="select" formControlName="status">
                <option>Agendado</option>
                <option>Concluído</option>
                <option>Cancelado</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="drawer__actions">
        <div class="actions-row">
          <button class="btn btn-primary" type="submit" [disabled]="form.invalid">Salvar</button>
          <button class="btn btn-outline" type="button" (click)="startCreate()">Limpar</button>
          <button class="btn btn-ghost" type="button" (click)="closeForm()">Cancelar</button>
        </div>
      </div>
    </form>

    <div class="drawer__edge"></div>
  </aside>

  <button class="fab" type="button" (click)="startCreate()" aria-label="Novo agendamento">＋</button>
</section>
